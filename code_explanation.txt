# コード解説 (Code Explanation)

このプロジェクトのPythonコードの構造と、主要なファイルのロジックについて解説します。

## 📂 ファイル構成

- **`bot.py`**: ボットの起動ファイル。データベースの初期化や設定の読み込みを行います。
- **`cogs/`**: ボットの機能ごとに分割されたファイル(Cog)が入っています。
  - **`cogs/broker.py`**: メインとなる「密輸」「鑑定」「トレンド」のロジックが含まれています。
  - **`cogs/setup.py`**: サーバーの初期設定(`!init_server`)を担当します。
  - **`cogs/market.py`**: 購入ボンタンなどのUI/Viewを担当します。
  - **`cogs/bank.py`**: お金の管理コマンドを担当します。

---

## 🔍 主要コードのロジック解説

### 1. `bot.py` (システムの中核)
ここでは `BankSystem` クラスが定義されており、すべての経済データ(所持金、アイテム情報、トレンド)を集約管理しています。
- **`initialize()`**: 起動時に `aiosqlite` を使って `economy.db` というデータベースを作成します。
  - `bank`: ユーザーの所持金テーブル
  - `market_items`: 取引されたアイテムの全データ
  - `daily_trends`: その日のトレンド情報

### 2. `cogs/broker.py` (ゲームの心臓部)
このファイルにゲームの面白い部分が詰まっています。

#### 🕵️ 密輸コマンド (`!smuggle`) の流れ
コード内の `smuggle` 関数では以下の処理を一気に行っています:

1.  **画像の取得**: ユーザーが添付した画像を一時フォルダにダウンロードします。
2.  **重複チェック (`get_risk_factor`)**:
    - `imagehash` というライブラリを使い、画像の「ハッシュ値(指紋のようなもの)」を計算します。
    - 過去に登録された画像のハッシュと比較し、似すぎている場合は「重複」として拒否します。
3.  **AI鑑定 (`Gradio Client`)**:
    - `waifu-scorer`: 画像の美しさを0~10点で採点します。(美的スコア)
    - `wd-tagger`: 画像に何が描かれているか(タグ)を解析します。(例: `blue_hair`, `cat_ears`など)
    - **Note:** この処理は外部のHugging Face SpacesのAPIを呼び出しています。
4.  **価格計算**:
    - 基本価格 + (スコア × 5000) + トレンドボーナス で価格が決まります。
    - スコアが4.0未満の場合、「ゴミ」とみなされ買取拒否されます。
5.  **出品処理**:
    - 成功すると、ボットがお金を支払い、Discordのフォーラムチャンネルに新しいスレッド(または既存スレッド)として商品を投稿します。

#### 📈 トレンド機能 (`update_daily_trends`)
- 毎日1回(または起動時)、`tags.json` からランダムに3つのタグ(姿勢、衣装、特徴)を選びます。
- これが「本日のトレンド」となり、これらのタグが含まれる画像を密輸するとボーナス金がもらえます。

#### 🔄 再販機能 (`!resell`)
- 自分が買ったアイテム(`buyer_id` が自分)をデータベース上で再び `on_sale` (販売中) ステータスに戻します。
- 同時に、Discord上のメッセージ内容を更新して、他の人が買えるようにします。

### 3. `cogs/setup.py` (環境構築)
- **`!init_server`**:
    - 面倒なチャンネル作成を自動化しています。
    - `guild.create_category`, `guild.create_forum`, `guild.create_role` などのDiscord APIを使って、ゲームに必要な環境を一発で整えます。

---

## 💡 初心者向けのヒント
- コードをいじるときは、まず `cogs/` フォルダの中身を見ると良いでしょう。機能ごとに分かれているので、例えば「密輸の金額を変えたい」なら `broker.py`、「初期設定を変えたい」なら `setup.py` を見ればOKです。
- データベースは `economy.db` というファイルに保存されます。これを削除するとデータが全て消えます。
